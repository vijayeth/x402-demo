<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>x402 Shop - Crypto Payments</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          "Inter",
          system-ui,
          -apple-system,
          sans-serif;
        background: #002133;
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
      }
      .header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
        padding: 20px 0;
      }
      .header h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .header p {
        font-size: 1.2rem;
        opacity: 0.95;
      }
      .badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        margin-top: 10px;
      }
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-bottom: 30px;
      }
      .product-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
      }
      .product-icon {
        font-size: 3rem;
        margin-bottom: 16px;
      }
      .product-name {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 8px;
      }
      .product-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #5162FF;
        margin-bottom: 16px;
      }
      .qty-control {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .qty-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 2px solid #5162FF;
        background: white;
        color: #5162FF;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .qty-btn:hover {
        background: #5162FF;
        color: white;
      }
      .qty-input {
        width: 60px;
        text-align: center;
        font-size: 1.1rem;
        font-weight: 600;
        padding: 8px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
      }
      .line-total {
        text-align: right;
        font-size: 1.2rem;
        font-weight: 600;
        color: #2d3748;
      }
      .cart-summary {
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      }
      .total-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
      }
      .total-label {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1a202c;
      }
      .total-amount {
        font-size: 2rem;
        font-weight: 700;
        color: #5162FF;
      }
      .checkout-btn {
        width: 100%;
        padding: 18px;
        border-radius: 12px;
        background: #5162FF;
        color: white;
        border: none;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        box-shadow: 0 4px 20px rgba(81, 98, 255, 0.4);
      }
      .checkout-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 30px rgba(81, 98, 255, 0.6);
      }
      .checkout-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .tx-info {
        margin-top: 20px;
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .tx-info-title {
        font-size: 1rem;
        font-weight: 600;
        color: #5162FF;
        margin-bottom: 12px;
      }
      .tx-hash-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .tx-label {
        font-weight: 600;
        color: #4a5568;
        flex-shrink: 0;
      }
      .tx-hash {
        font-family: monospace;
        font-size: 0.85rem;
        color: #5162FF;
        word-break: break-all;
        text-decoration: none;
      }
      .tx-hash:hover {
        text-decoration: underline;
      }
      .toast-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 400px;
      }
      .toast {
        background: white;
        border-radius: 12px;
        padding: 20px 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: flex-start;
        gap: 16px;
        animation: slideIn 0.3s ease-out;
        position: relative;
      }
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
      .toast.removing {
        animation: slideOut 0.3s ease-in;
      }
      .toast-icon {
        font-size: 1.8rem;
        flex-shrink: 0;
      }
      .toast-content {
        flex: 1;
      }
      .toast-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 6px;
        color: #1a202c;
      }
      .toast-message {
        font-size: 0.95rem;
        color: #4a5568;
        line-height: 1.5;
      }
      .toast-link {
        color: #5162FF;
        text-decoration: none;
        font-weight: 600;
        display: inline-block;
        margin-top: 8px;
      }
      .toast-link:hover {
        text-decoration: underline;
      }
      .toast-close {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #a0aec0;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
      }
      .toast-close:hover {
        color: #1a202c;
      }
      .toast-retry-btn {
        margin-top: 12px;
        padding: 8px 16px;
        background: #5162FF;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }
      .toast-retry-btn:hover {
        background: #4152E0;
      }
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #e2e8f0;
        border-top: 2px solid #5162FF;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <div class="container">
      <div class="header">
        <h1>üõí x402 Shop</h1>
        <p>Pay with crypto in seconds</p>
        <span class="badge">üîê Secure ‚Ä¢ ‚ö° Instant ‚Ä¢ üíé On-Chain</span>
      </div>

      <!-- Network & Token Selector -->
      <div
        style="
          text-align: center;
          margin-bottom: 25px;
          padding: 20px;
          background: rgba(255, 255, 255, 0.15);
          border-radius: 16px;
          backdrop-filter: blur(10px);
          display: flex;
          gap: 30px;
          justify-content: center;
          align-items: center;
          flex-wrap: wrap;
        "
      >
        <div>
          <label style="color: white; font-weight: 600; margin-right: 12px; font-size: 1.1rem"
            >Network:</label
          >
          <select
            id="network-selector"
            style="
              padding: 10px 20px;
              border-radius: 10px;
              border: 2px solid white;
              font-weight: 600;
              font-size: 1rem;
              background: white;
              color: #5162FF;
              cursor: pointer;
            "
          >
            <option value="filecoin-calibration">üåê Filecoin Calibration</option>
            <option value="sepolia">üåê Sepolia</option>
          </select>
        </div>
        <div>
          <label style="color: white; font-weight: 600; margin-right: 12px; font-size: 1.1rem"
            >Token:</label
          >
          <select
            id="token-selector"
            style="
              padding: 10px 20px;
              border-radius: 10px;
              border: 2px solid white;
              font-weight: 600;
              font-size: 1rem;
              background: white;
              color: #5162FF;
              cursor: pointer;
            "
          >
            <option value="">All Available</option>
            <option value="JPYC">JPYC üí¥</option>
            <option value="USDFC">USDFC üí∞</option>
          </select>
        </div>
      </div>

      <!-- Wallet connection -->
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
        "
      >
        <div>
          <span id="network-status" style="color: white; font-weight: 600">‚õì Not connected</span>
        </div>
        <button
          id="connect-wallet"
          style="
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            background: white;
            color: #5162FF;
            font-weight: 600;
            cursor: pointer;
          "
        >
          üîå Connect Wallet
        </button>
      </div>

      <div id="catalog" class="products-grid"></div>

      <div class="cart-summary">
        <div class="total-section">
          <div>
            <span class="total-label">Total</span>
            <div style="font-size: 0.95rem; color: #718096">
              Pay in: <b id="pay-token">USDFC üí∞</b>
            </div>
          </div>
          <span class="total-amount" id="total">$0.00</span>
        </div>
        <button id="checkout" class="checkout-btn" disabled>üîí Secure Checkout</button>
      </div>

      <!-- Transaction Info (shown after payment) -->
      <div id="tx-info" class="tx-info" style="display: none">
        <div class="tx-info-title">Transaction Complete</div>
        <div class="tx-hash-row">
          <span class="tx-label">TX Hash:</span>
          <a id="tx-hash-link" href="#" target="_blank" class="tx-hash">-</a>
        </div>
      </div>
    </div>

    <script>
      const NETWORKS = {
        "filecoin-calibration": {
          chainId: "0x4cb2f",
          chainName: "Filecoin Calibration Testnet",
          nativeCurrency: { name: "tFIL", symbol: "tFIL", decimals: 18 },
          rpcUrls: ["https://api.calibration.node.glif.io/rpc/v1"],
          blockExplorerUrls: ["https://calibration.filfox.info/en"],
          token: "USDFC üí∞",
          displayName: "Filecoin Calibration",
          availableTokens: ["USDFC"],
          exchangeRate: 1, // 1 USD = 1 USDFC
        },
        sepolia: {
          chainId: "0xaa36a7",
          chainName: "Sepolia Testnet",
          nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
          rpcUrls: ["https://ethereum-sepolia-rpc.publicnode.com"],
          blockExplorerUrls: ["https://sepolia.etherscan.io"],
          token: "JPYC üí¥",
          displayName: "Sepolia",
          availableTokens: ["JPYC"],
          exchangeRate: 150, // 1 USD = 150 JPYC
        },
      };

      // Helper function to convert USD price to selected token amount
      function convertPrice(usdPrice, network) {
        const rate = NETWORKS[network].exchangeRate;
        return (usdPrice * rate).toFixed(rate >= 10 ? 0 : 2);
      }

      // Helper function to get token symbol with emoji
      function getTokenDisplay(network) {
        const token = NETWORKS[network].availableTokens[0];
        const emoji = token === "JPYC" ? "üí¥" : "üí∞";
        return { token, emoji };
      }

      let selectedNetwork = "filecoin-calibration";
      let selectedToken = ""; // Empty means "all available tokens"
      let userAddress = null;

      // Toast notification system
      let toastIdCounter = 0;

      function showToast({
        type = "info",
        title,
        message,
        link,
        linkText,
        retryFn,
        duration = null,
        id = null,
      }) {
        const toastId = id || `toast-${toastIdCounter++}`;
        const container = document.getElementById("toast-container");

        // Remove existing toast with same ID
        const existing = document.getElementById(toastId);
        if (existing) {
          existing.remove();
        }

        const icons = {
          info: "üìã",
          success: "‚úÖ",
          error: "‚ùå",
          warning: "‚ö†Ô∏è",
          pending: '<span class="spinner"></span>',
        };

        const toast = document.createElement("div");
        toast.className = "toast";
        toast.id = toastId;

        toast.innerHTML = `
          <div class="toast-icon">${icons[type] || icons.info}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
            ${link ? `<a href="${link}" target="_blank" class="toast-link">${linkText || "View Transaction"}</a>` : ""}
            ${retryFn ? '<button class="toast-retry-btn">Retry Payment</button>' : ""}
          </div>
          <button class="toast-close">√ó</button>
        `;

        container.appendChild(toast);

        // Close button handler
        toast.querySelector(".toast-close").addEventListener("click", () => {
          removeToast(toastId);
        });

        // Retry button handler
        if (retryFn) {
          toast.querySelector(".toast-retry-btn").addEventListener("click", () => {
            removeToast(toastId);
            retryFn();
          });
        }

        // Auto-remove after duration (if specified)
        if (duration) {
          setTimeout(() => removeToast(toastId), duration);
        }

        return toastId;
      }

      function removeToast(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
          toast.classList.add("removing");
          setTimeout(() => toast.remove(), 300);
        }
      }

      function updateToast(toastId, options) {
        removeToast(toastId);
        return showToast({ ...options, id: toastId });
      }

      function updateTokenSelector() {
        const tokenSelector = document.getElementById("token-selector");
        const network = NETWORKS[selectedNetwork];
        const availableTokens = network.availableTokens || [];

        // Clear existing options
        tokenSelector.innerHTML = "";

        // Add available tokens for the selected network
        availableTokens.forEach(token => {
          const option = document.createElement("option");
          option.value = token;
          const emoji = token === "JPYC" ? "üí¥" : "üí∞";
          option.textContent = `${token} ${emoji}`;
          tokenSelector.appendChild(option);
        });

        // Set the first token as selected
        if (availableTokens.length > 0) {
          selectedToken = availableTokens[0];
          tokenSelector.value = selectedToken;
        }
      }

      async function ensureCorrectChain() {
        const network = NETWORKS[selectedNetwork];
        if (!window.ethereum) throw new Error("MetaMask not detected");
        try {
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: network.chainId }],
          });
        } catch (err) {
          if (err.code === 4902) {
            await window.ethereum.request({
              method: "wallet_addEthereumChain",
              params: [network],
            });
          } else {
            throw err;
          }
        }
      }

      async function connectWallet() {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        userAddress = accounts[0];
        await ensureCorrectChain();
        updateWalletUI();
      }

      function shortAddr(a) {
        return a ? `${a.slice(0, 6)}...${a.slice(-4)}` : "";
      }

      function updateWalletUI() {
        const connectBtn = document.getElementById("connect-wallet");
        const netStatus = document.getElementById("network-status");
        const network = NETWORKS[selectedNetwork];
        if (userAddress) {
          connectBtn.textContent = shortAddr(userAddress);
          connectBtn.style.background = "#5162FF";
          connectBtn.style.color = "white";
          netStatus.textContent = `üåê ${network.displayName}`;
          netStatus.style.color = "#C6F6D5";
        }
      }

      async function fetchProducts() {
        const res = await fetch("/products");
        return await res.json();
      }

      (async function init() {
        const data = await fetchProducts();
        const catalog = document.getElementById("catalog");
        const totalEl = document.getElementById("total");
        const checkoutBtn = document.getElementById("checkout");
        const connectBtn = document.getElementById("connect-wallet");
        const networkSelector = document.getElementById("network-selector");
        const tokenSelector = document.getElementById("token-selector");
        const payTokenEl = document.getElementById("pay-token");

        connectBtn.addEventListener("click", connectWallet);

        networkSelector.addEventListener("change", e => {
          selectedNetwork = e.target.value;
          updateTokenSelector();
          const { token, emoji } = getTokenDisplay(selectedNetwork);
          payTokenEl.textContent = `${token} ${emoji}`;
          updateWalletUI();
          render();
        });

        tokenSelector.addEventListener("change", e => {
          selectedToken = e.target.value;
          // Update display if specific token selected
          if (selectedToken) {
            const emoji = selectedToken === "JPYC" ? "üí¥" : "üí∞";
            payTokenEl.textContent = `${selectedToken} ${emoji}`;
          }
        });

        // Initialize token selector based on default network
        updateTokenSelector();
        const { token: initToken, emoji: initEmoji } = getTokenDisplay(selectedNetwork);
        payTokenEl.textContent = `${initToken} ${initEmoji}`;

        const products = data.products;
        const state = products.map(p => ({ ...p, qty: 0 }));

        function render() {
          catalog.innerHTML = "";
          const { token, emoji } = getTokenDisplay(selectedNetwork);

          state.forEach((s, idx) => {
            const div = document.createElement("div");
            div.className = "product-card";
            const convertedPrice = convertPrice(s.priceUSD, selectedNetwork);
            const lineTotal = convertPrice(s.qty * s.priceUSD, selectedNetwork);

            div.innerHTML = `
              <div class="product-icon">${["üé®", "üëï", "‚òï"][idx] || "üì¶"}</div>
              <div class="product-name">${s.name}</div>
              <div class="product-price">${convertedPrice} ${token} ${emoji}</div>
              <div class="qty-control">
                <button class="qty-btn" data-idx="${idx}" data-action="dec">‚àí</button>
                <input class="qty-input" type="number" value="${s.qty}" readonly />
                <button class="qty-btn" data-idx="${idx}" data-action="inc">+</button>
              </div>
              <div class="line-total">${lineTotal} ${token} ${emoji}</div>`;
            catalog.appendChild(div);
          });

          const totalUSD = state.reduce((acc, s) => acc + s.qty * s.priceUSD, 0);
          const convertedTotal = convertPrice(totalUSD, selectedNetwork);
          totalEl.textContent = `${convertedTotal} ${token} ${emoji}`;
          checkoutBtn.disabled = totalUSD <= 0 || !userAddress;
        }

        catalog.addEventListener("click", e => {
          const btn = e.target.closest(".qty-btn");
          if (!btn) return;
          const idx = Number(btn.getAttribute("data-idx"));
          const action = btn.getAttribute("data-action");
          if (action === "inc") state[idx].qty++;
          else if (action === "dec" && state[idx].qty > 0) state[idx].qty--;
          render();
        });

        checkoutBtn.addEventListener("click", async () => {
          try {
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = "Processing...";

            const items = state.filter(s => s.qty > 0);

            // Build checkout URL
            let url = `/checkout-page?items=${encodeURIComponent(JSON.stringify(items))}&network=${selectedNetwork}`;
            if (selectedToken) {
              url += `&token=${selectedToken}`;
            }

            // Traditional blocking flow - let x402 middleware handle the payment
            window.location.href = url;
          } catch (err) {
            console.error("Checkout error:", err);
            alert("Error: " + err.message);
          } finally {
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = "üîí Secure Checkout";
          }
        });

        render();
      })();
    </script>
  </body>
</html>
